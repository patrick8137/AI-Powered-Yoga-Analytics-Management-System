{% extends "base.html" %}
{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block content %}
<div class="glass-card p-3 mb-3 d-flex align-items-center shadow-sm">
    <a href="{% url 'inbox' %}" class="btn btn-sm btn-light rounded-circle me-3">
        <i class="bi bi-arrow-left"></i>
    </a>
    <div class="avatar-circle me-2 d-flex align-items-center justify-content-center bg-primary text-white fw-bold" 
         style="width: 40px; height: 40px; border-radius: 50%;">
        {{ other_user.username|first|upper }}
    </div>
    <h5 class="mb-0 fw-bold text-dark">{{ other_user.get_full_name|default:other_user.username }}</h5>
</div>

<div class="glass-card p-4 mb-3 shadow-sm" id="chat-window" style="height: 500px; overflow-y: auto; background: rgba(255, 255, 255, 0.3);">
    <div class="d-flex flex-column gap-3">
        {% for msg in messages %}
            <div class="d-flex flex-column {% if msg.sender == request.user %}align-items-end{% else %}align-items-start{% endif %}">
                
                <div class="p-3 shadow-sm" style="max-width: 75%; border-radius: 18px; 
                    {% if msg.sender == request.user %}
                        background: #0d6efd; color: white; border-bottom-right-radius: 4px;
                    {% else %}
                        background: white; color: #333; border-bottom-left-radius: 4px;
                    {% endif %}">
                    
                    <p class="mb-1">{{ msg.content }}</p>
                    <div class="text-end" style="font-size: 0.7rem; opacity: 0.8;">
                        {{ msg.created_at|date:"H:i" }}
                    </div>
                </div>
                
                {% if msg.sender != request.user %}
                    <small class="text-muted mt-1 ms-1" style="font-size: 0.75rem;">
                        {{ msg.sender.get_full_name|default:msg.sender.username }}
                    </small>
                {% endif %}
            </div>
        {% empty %}
            <div class="text-center text-muted my-auto">
                <p>No messages yet. Say hello!</p>
            </div>
        {% endfor %}
    </div>
</div>

<form method="post" class="glass-card p-2 shadow-sm border-0">
    {% csrf_token %}
    <div class="input-group">
        <input type="text" name="content" class="form-control border-0 bg-transparent py-2" 
               placeholder="Write a message..." required autofocus>
        <button class="btn btn-primary rounded-pill px-4 ms-2">
            <i class="bi bi-send-fill me-1"></i> Send
        </button>
    </div>
</form>

<script>
    const chatWindow = document.getElementById('chat-window');
    chatWindow.scrollTop = chatWindow.scrollHeight;
</script>

<style>
    /* Custom Scrollbar for the glass-card */
    #chat-window::-webkit-scrollbar {
        width: 6px;
    }
    #chat-window::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.1);
        border-radius: 10px;
    }
</style>
{% endblock %}